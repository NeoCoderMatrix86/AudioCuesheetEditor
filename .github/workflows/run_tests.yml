name: Run Tests

on:
  workflow_call:
  pull_request:

jobs:    
  run-tests:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4.2.2

    - name: Set timestamp variable
      id: timestamp
      run: echo "datetime=$(date +'%Y-%m-%d_%H-%M-%S')" >> $GITHUB_OUTPUT
    
    # version can be found here https://dotnet.microsoft.com/en-us/download/dotnet/9.0
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 9.0.x

    - name: Install wasm-tools
      run: dotnet workload install wasm-tools-net9

    - name: Build & Install
      run: dotnet build
    - name: Ensure browsers are installed
      run: pwsh AudioCuesheetEditor.End2EndTests/bin/Debug/net9.0/playwright.ps1 install --with-deps

    - name: Start App
      run: dotnet run --project AudioCuesheetEditor &

    - name: Wait for app to be ready
      run: |
        echo "Waiting for http://localhost:5132 to respond..."
        success_count=0
        for i in {1..60}; do
          if curl -sSf http://localhost:5132 >/dev/null; then
            success_count=$((success_count+1))
            echo "Health check passed ($success_count/5)"
            if [ "$success_count" -ge 5 ]; then
              echo "App is stable and ready"
            exit 0
          fi
          else
            success_count=0
            echo "Not ready yet ($i/60)..."
          fi
          sleep 2
        done
        echo "App never became ready" >&2
        exit 1
      shell: bash

    - name: Run tests
      run: dotnet test

    - name: Upload traces
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: playwright-traces-${{ steps.timestamp.outputs.datetime }}
        path: AudioCuesheetEditor.End2EndTests/bin/Debug/net9.0/playwright-traces/
        if-no-files-found: ignore
