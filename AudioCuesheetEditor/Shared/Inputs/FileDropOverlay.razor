<!--
This file is part of AudioCuesheetEditor.

AudioCuesheetEditor is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

AudioCuesheetEditor is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with Foobar.  If not, see
<http: //www.gnu.org/licenses />.
-->
@inherits BaseLocalizedComponent

@implements IAsyncDisposable

@inject IJSRuntime _jsRuntime
@inject IStringLocalizer<FileDropOverlay> _localizer

<MudOverlay Visible="@_showOverlay" DarkBackground Class="pa-0" Absolute ZIndex="9999" Modal>
    <MudFileUpload T="IReadOnlyList<IBrowserFile>" OnFilesChanged="OnInputFileChanged" AppendMultipleFiles Hidden="false" InputClass="file-upload-input" tabindex="-1">
        <ActivatorContent>
            <MudPaper Class="@_dragClass" Width="100vw" Height="100vh" Style="margin:0;opacity:0.65;">
                <MudStack AlignItems="AlignItems.Center">
                    <MudIcon Icon="@Icons.Material.Filled.CloudUpload" Size="Size.Large" Color="Color.Primary" />
                    <MudText Typo="Typo.h6">@_localizer["Drop files here to upload"]</MudText>
                </MudStack>
            </MudPaper>
        </ActivatorContent>
    </MudFileUpload>
</MudOverlay>

@code {
    //TODO: localization

    private DotNetObjectReference<FileDropOverlay>? _dotNetRef;
    private bool _showOverlay;
    private bool _disposed;
    private const string DefaultDragClass = "d-flex align-center justify-center position-relative";
    private string _dragClass = DefaultDragClass;

    protected override async Task OnInitializedAsync()
    {
        _dotNetRef = DotNetObjectReference.Create(this);
        await _jsRuntime.InvokeVoidAsync("globalFileDrag.register", _dotNetRef);
    }

    [JSInvokable("OnGlobalDragEnter")]
    public Task OnGlobalDragEnterAsync()
    {
        if (!_showOverlay)
        {
            _showOverlay = true;
            StateHasChanged();
        }
        return Task.CompletedTask;
    }

    [JSInvokable("OnGlobalDragLeave")]
    public Task OnGlobalDragLeaveAsync()
    {
        if (_showOverlay)
        {
            _showOverlay = false;
            ClearDragClass();
            StateHasChanged();
        }
        return Task.CompletedTask;
    }

    async Task OnInputFileChanged(InputFileChangeEventArgs e)
    {
        //TODO: send files to a service or an event

        ClearDragClass();
        _showOverlay = false;
        await _jsRuntime.InvokeVoidAsync("globalFileDrag.reset", _dotNetRef);
        StateHasChanged();
    }

    void SetDragClass() => _dragClass = $"{DefaultDragClass} mud-border-primary";

    void ClearDragClass() => _dragClass = DefaultDragClass;

    public async ValueTask DisposeAsync()
    {
        if (_disposed) 
        {
            return; 
        }

        _disposed = true;
        await _jsRuntime.InvokeVoidAsync("globalFileDrag.unregister");
        _dotNetRef?.Dispose();
    }
}
