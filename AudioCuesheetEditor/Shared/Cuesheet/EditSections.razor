<!--
This file is part of AudioCuesheetEditor.

AudioCuesheetEditor is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

AudioCuesheetEditor is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with Foobar.  If not, see
<http: //www.gnu.org/licenses />.
-->
@inherits BaseLocalizedComponent

@inject IStringLocalizer<EditSections> _localizer
@inject ApplicationOptionsTimeSpanParser _applicationOptionsTimeSpanParser
@inject ValidationService _validationService

<MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="AddSectionClicked" StartIcon="@Icons.Material.Outlined.Add">@_localizer["Add new section"]</MudButton>

<MudDataGrid Items="Cuesheet?.Sections" ReadOnly="false" Bordered EditTrigger="DataGridEditTrigger.OnRowClick" EditMode="DataGridEditMode.Cell" ColumnResizeMode="ResizeMode.Column">
    <Columns>
        <TemplateColumn Title="@_localizer["Controls"]" Editable="false">
            <CellTemplate>
                <MudIconButton Color="Color.Error" Variant="Variant.Filled" Icon="@Icons.Material.Outlined.Delete" OnClick="() => Cuesheet?.RemoveSection(context.Item)" />
            </CellTemplate>
        </TemplateColumn>
        <PropertyColumn Property="x => x.Begin" Title="@_localizer["Begin"]">
            <EditTemplate>
                <MudTextField Value="@context.Item.Begin.ToString()" ValueChanged="(string value) => _applicationOptionsTimeSpanParser.TimespanTextChanged<CuesheetSection, TimeSpan?>(context.Item, x => x.Begin, value)"
                              Error="!String.IsNullOrEmpty(GetValidationErrorMessage(context.Item, nameof(CuesheetSection.Begin)))" ErrorText="@GetValidationErrorMessage(context.Item, nameof(CuesheetSection.Begin))" />
            </EditTemplate>
        </PropertyColumn>
        <PropertyColumn Property="x => x.End" Title="@_localizer["End"]">
            <EditTemplate>
                <MudTextField Value="@context.Item.End.ToString()" ValueChanged="(string value) => _applicationOptionsTimeSpanParser.TimespanTextChanged<CuesheetSection, TimeSpan?>(context.Item, x => x.End, value)" 
                              Error="!String.IsNullOrEmpty(GetValidationErrorMessage(context.Item, nameof(CuesheetSection.End)))" ErrorText="@GetValidationErrorMessage(context.Item, nameof(CuesheetSection.End))" />
            </EditTemplate>
        </PropertyColumn>
        <PropertyColumn Property="x => x.Artist" Title="@_localizer["Cuesheet artist"]">
            <EditTemplate>
                <MudTextField @bind-Value="context.Item.Artist" Error="!String.IsNullOrEmpty(GetValidationErrorMessage(context.Item, nameof(CuesheetSection.Artist)))" ErrorText="@GetValidationErrorMessage(context.Item, nameof(CuesheetSection.Artist))" />
            </EditTemplate>
        </PropertyColumn>
        <PropertyColumn Property="x => x.Title" Title="@_localizer["Cuesheet title"]">
            <EditTemplate>
                <MudTextField @bind-Value="context.Item.Title" Error="!String.IsNullOrEmpty(GetValidationErrorMessage(context.Item, nameof(CuesheetSection.Title)))" ErrorText="@GetValidationErrorMessage(context.Item, nameof(CuesheetSection.Title))" />
            </EditTemplate>
        </PropertyColumn>
    </Columns>
</MudDataGrid>

@code {
    //TOOD: Localization
    //TODO: Controls column
    //TODO: audiofile column
    //TODO: Tooltip for controls

    [CascadingParameter]
    public Cuesheet? Cuesheet { get; set; }

    void AddSectionClicked()
    {
        if (Cuesheet != null)
        {
            var section = Cuesheet.AddSection();
            TraceChangeManager.TraceChanges(section);
        }
    }

    String? GetValidationErrorMessage(object model, string propertyName)
    {
        String? validationErrorMessage = null;
        var validationMessages = _validationService.Validate(model, propertyName);
        if (validationMessages.Count() > 0)
        {
            validationErrorMessage = String.Join(Environment.NewLine, validationMessages);
        }
        return validationErrorMessage;
    }
}
